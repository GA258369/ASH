# ä»æ¼æ´åˆ°é˜²å¾¡ï¼šæˆ‘ç”¨Spring Bootæ„å»ºä¼ä¸šçº§å®‰å…¨ç™»å½•ç³»ç»Ÿ

> æœ¬ç³»åˆ—è®°å½•æˆ‘ä½œä¸ºæ°‘åŠæœ¬ç§‘è½¯ä»¶å·¥ç¨‹å¤§ä¸‰å­¦ç”Ÿï¼Œå¦‚ä½•ä»é›¶æ„å»ºå…·å¤‡ä¼ä¸šçº§å®‰å…¨æ ‡å‡†çš„ç™»å½•ç³»ç»Ÿã€‚ç»§[ç¬¬ä¸€å‘¨SQLæ³¨å…¥æ”»é˜²](./Week1-SQL-Injection.md)åï¼Œæˆ‘å®Œæˆäº†å¯†ç åŠ å¯†ã€éªŒè¯ç ã€é˜²æš´åŠ›ç ´è§£ç­‰å…¨æ–¹ä½å®‰å…¨é˜²æŠ¤ã€‚

## ğŸ¯ é¡¹ç›®æˆæœæ¦‚è§ˆ

ç»è¿‡æ·±å…¥å¼€å‘ï¼Œæˆ‘æˆåŠŸæ„å»ºäº†ä¸€ä¸ªå…·å¤‡**äº”å±‚å®‰å…¨é˜²æŠ¤**çš„ç™»å½•ç³»ç»Ÿï¼š

- âœ… **SQLæ³¨å…¥é˜²æŠ¤** - JdbcTemplateå‚æ•°åŒ–æŸ¥è¯¢
- âœ… **å¯†ç å®‰å…¨åŠ å›º** - BCryptå¼ºå“ˆå¸Œç®—æ³•åŠ å¯†å­˜å‚¨  
- âœ… **éªŒè¯ç ç³»ç»Ÿ** - Kaptchaå›¾å½¢éªŒè¯ç é˜²è‡ªåŠ¨åŒ–æ”»å‡»
- âœ… **æš´åŠ›ç ´è§£é˜²å¾¡** - ç™»å½•å¤±è´¥é”å®šæœºåˆ¶ï¼ˆ5æ¬¡å¤±è´¥é”å®š30åˆ†é’Ÿï¼‰
- âœ… **ä¼šè¯å®‰å…¨** - éªŒè¯ç ä¸€æ¬¡æ€§ä½¿ç”¨é˜²é‡æ”¾æ”»å‡»

## ğŸ› ï¸ å®Œæ•´æŠ€æœ¯æ¶æ„

### åç«¯æŠ€æœ¯æ ˆ
- **æ ¸å¿ƒæ¡†æ¶**ï¼šSpring Boot 3.4.11 + Java 21
- **å®‰å…¨ç»„ä»¶**ï¼šSpring Security Crypto + KaptchaéªŒè¯ç 
- **æ•°æ®æŒä¹…å±‚**ï¼šSpring Data JPA + JdbcTemplate
- **æ¨¡æ¿å¼•æ“**ï¼šThymeleaf

### å‰ç«¯æŠ€æœ¯æ ˆ
- **é¡µé¢ç»“æ„**ï¼šHTML5 + Thymeleafæ¨¡æ¿
- **æ ·å¼è¡¨ç°**ï¼šå†…è”CSS
- **äº¤äº’é€»è¾‘**ï¼šåŸç”ŸJavaScriptï¼ˆéªŒè¯ç åˆ·æ–°ï¼‰

### æ•°æ®åº“è®¾è®¡
```sql
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,  -- BCryptå“ˆå¸Œå€¼
    login_attempts INT DEFAULT 0,
    lock_time TIMESTAMP NULL
);
```

## ğŸ” å¤šå±‚æ¬¡å®‰å…¨é˜²æŠ¤å®ç°

### 1. SQLæ³¨å…¥å½»åº•é˜²æŠ¤

åœ¨`AuthController`ä¸­ï¼Œæˆ‘å…¨é¢ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼š

```java
@PostMapping("/register")
public String register(@RequestParam String username, 
                      @RequestParam String password, Model model) {
    try {
        String encodedPassword = passwordEncoder.encode(password);
        // âœ… å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢SQLæ³¨å…¥
        String sql = "INSERT INTO users(username, password) VALUES (?, ?)";
        jdbcTemplate.update(sql, username, encodedPassword);
        model.addAttribute("message", "æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•ã€‚");
        return "register";
    } catch (Exception e) {
        model.addAttribute("message", "æ³¨å†Œå¤±è´¥ï¼šç”¨æˆ·åå¯èƒ½å·²å­˜åœ¨ï¼");
        return "register";
    }
}
```

### 2. å¯†ç å®‰å…¨ï¼šBCryptå¼ºå“ˆå¸ŒåŠ å¯†

é€šè¿‡`SecurityConfig`é…ç½®å¯†ç ç¼–ç å™¨ï¼š

```java
@Configuration
public class SecurityConfig {
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
```

åœ¨ä¸šåŠ¡å±‚åº”ç”¨å¯†ç åŠ å¯†ä¸éªŒè¯ï¼š

```java
@Autowired
private PasswordEncoder passwordEncoder;

// æ³¨å†Œæ—¶åŠ å¯†å¯†ç 
String encodedPassword = passwordEncoder.encode(password);

// ç™»å½•æ—¶éªŒè¯å¯†ç 
if (passwordEncoder.matches(password, storedHash)) {
    // ç™»å½•æˆåŠŸé€»è¾‘
}
```

**å¯†ç å­˜å‚¨å¯¹æ¯”ï¼š**
- ä¿®å¤å‰ï¼š`123456` â†’ æ˜æ–‡å­˜å‚¨
- ä¿®å¤åï¼š`$2a$10$N9qo8uLOickgx2ZMRZoMye.KbVkYJ.8a...` â†’ BCryptå“ˆå¸Œ

### 3. éªŒè¯ç ç³»ç»Ÿï¼šé˜²å¾¡è‡ªåŠ¨åŒ–æ”»å‡»

**é…ç½®å±‚** - `KaptchaConfig.java`ï¼š
```java
@Bean
public DefaultKaptcha defaultKaptcha() {
    DefaultKaptcha captcha = new DefaultKaptcha();
    Properties properties = new Properties();
    properties.put("kaptcha.textproducer.char.length", "4");
    properties.put("kaptcha.textproducer.char.string", "0123456789abcdefghijklmnopqrstuvwxyz");
    properties.put("kaptcha.image.width", "130");
    properties.put("kaptcha.image.height", "48");
    properties.put("kaptcha.border", "no");
    Config config = new Config(properties);
    captcha.setConfig(config);
    return captcha;
}
```

**æ§åˆ¶å±‚** - `CaptchaController.java`ï¼š
```java
@GetMapping("/captcha")
public void captcha(HttpServletRequest request, HttpServletResponse response) throws IOException {
    response.setHeader("Cache-Control", "no-cache"); // é˜²æ­¢ç¼“å­˜
    response.setContentType("image/jpeg");
    
    String captchaText = captchaProducer.createText();
    // âœ… å­˜å‚¨åˆ°Sessionï¼ŒéªŒè¯åç«‹å³æ¸…é™¤é˜²é‡æ”¾æ”»å‡»
    request.getSession().setAttribute("captcha", captchaText);
    
    BufferedImage image = captchaProducer.createImage(captchaText);
    ImageIO.write(image, "jpg", response.getOutputStream());
}
```

**å‰ç«¯é›†æˆ** - `login.html`ï¼š
```html
<div class="captcha-container">
    <input type="text" name="captchaInput" required>
    <img id="captchaImg" class="captcha-img" src="/captcha" 
         onclick="this.src='/captcha?' + Math.random()">
</div>
```

### 4. é˜²æš´åŠ›ç ´è§£ï¼šæ™ºèƒ½è´¦æˆ·é”å®š

åœ¨`AuthController`ä¸­å®ç°å®Œæ•´çš„ç™»å½•ä¿æŠ¤é€»è¾‘ï¼š

```java
@PostMapping("/login-safe")
public String loginSafe(@RequestParam String username, 
                       @RequestParam String password,
                       @RequestParam String captchaInput,
                       Model model, HttpServletRequest request) {
    
    // 1. éªŒè¯ç æ ¡éªŒï¼ˆä¸€æ¬¡æ€§ä½¿ç”¨ï¼‰
    String captchaInSession = (String) request.getSession().getAttribute("captcha");
    if (captchaInSession == null || !captchaInSession.equals(captchaInput)) {
        model.addAttribute("message", "éªŒè¯ç é”™è¯¯ï¼");
        return "login";
    }
    request.getSession().removeAttribute("captcha"); // âœ… ç«‹å³æ¸…é™¤é˜²é‡æ”¾
    
    // 2. æ£€æŸ¥è´¦æˆ·é”å®šçŠ¶æ€
    String queryUserSql = "SELECT login_attempts, lock_time FROM users WHERE username = ?";
    try {
        Object[] userStatus = jdbcTemplate.queryForObject(queryUserSql, (rs, rowNum) ->
                new Object[]{rs.getInt("login_attempts"), rs.getTimestamp("lock_time")}, username);

        if (userStatus != null) {
            int attempts = (Integer) userStatus[0];
            java.sql.Timestamp lockTime = (java.sql.Timestamp) userStatus[1];

            // 3. é”å®šæ£€æŸ¥ï¼ˆ30åˆ†é’Ÿé”å®šæœºåˆ¶ï¼‰
            if (lockTime != null) {
                long lockMillis = lockTime.getTime();
                long now = System.currentTimeMillis();
                if (now - lockMillis < 30 * 60 * 1000) {
                    long remaining = (30 * 60 * 1000 - (now - lockMillis)) / 1000;
                    model.addAttribute("message", "è´¦æˆ·å·²è¢«é”å®šï¼Œè¯· " + remaining + " ç§’åå†è¯•ã€‚");
                    return "login";
                } else {
                    // é”å®šæ—¶é—´è¿‡æœŸï¼Œé‡ç½®çŠ¶æ€
                    jdbcTemplate.update("UPDATE users SET login_attempts = 0, lock_time = NULL WHERE username = ?", username);
                }
            }
        }
    } catch (Exception e) {
        model.addAttribute("message", "ç”¨æˆ·ä¸å­˜åœ¨ã€‚");
        return "login";
    }

    // 4. å¯†ç éªŒè¯ä¸å¤±è´¥è®¡æ•°
    // ... [è¯¦ç»†çš„å¯†ç éªŒè¯å’Œå¤±è´¥å¤„ç†é€»è¾‘]
}
```

## ğŸ“Š å®‰å…¨é˜²æŠ¤æ•ˆæœéªŒè¯

### æ”»å‡»æµ‹è¯•å®Œæ•´æŠ¥å‘Š

| æ”»å‡»ç±»å‹ | é˜²æŠ¤æªæ–½ | æµ‹è¯•ç»“æœ | ç”¨æˆ·ä½“éªŒå½±å“ |
|---------|----------|----------|--------------|
| SQLæ³¨å…¥ | å‚æ•°åŒ–æŸ¥è¯¢ | âŒ å®Œå…¨é˜²å¾¡ | æ— å½±å“ |
| å¯†ç ç ´è§£ | BCryptå“ˆå¸Œ | âŒ å“ˆå¸Œä¸å¯é€† | æ— æ„ŸçŸ¥ |
| æš´åŠ›ç ´è§£ | å¤±è´¥é”å®š+éªŒè¯ç  | âŒ 5æ¬¡åé”å®š | è½»åº¦å¹²æ‰° |
| éªŒè¯ç é‡æ”¾ | Sessionä¸€æ¬¡æ€§ä½¿ç”¨ | âŒ æ— æ³•é‡å¤ä½¿ç”¨ | æ— æ„ŸçŸ¥ |
| è‡ªåŠ¨åŒ–è„šæœ¬ | å›¾å½¢éªŒè¯ç  | âŒ OCRè¯†åˆ«éš¾åº¦é«˜ | éœ€è¦è¾“å…¥éªŒè¯ç  |

### æ€§èƒ½ä¼˜åŒ–æˆæœ

- **å“åº”æ—¶é—´**ï¼šä¸»è¦æ¥å£å¹³å‡å“åº” < 100ms
- **å¹¶å‘æ”¯æŒ**ï¼šéªŒè¯ç ç”Ÿæˆé‡‡ç”¨ç¼“å­˜ä¼˜åŒ–
- **èµ„æºæ¶ˆè€—**ï¼šBCryptå“ˆå¸Œè®¡ç®—åœ¨å¯æ¥å—èŒƒå›´å†…
- **ç”¨æˆ·ä½“éªŒ**ï¼š5æ¬¡å¤±è´¥åæ‰éœ€è¦éªŒè¯ç ï¼Œå¹³è¡¡å®‰å…¨ä¸ä¾¿åˆ©

## ğŸ“ æŠ€æœ¯æˆé•¿ä¸çªç ´

### æ ¸å¿ƒæŠ€èƒ½æå‡

1. **Spring Bootæ·±åº¦å®è·µ**
   - å¤šControllerååŒå·¥ä½œ
   - è‡ªå®šä¹‰é…ç½®ç±»(`@Configuration`)
   - ä¾èµ–æ³¨å…¥(`@Autowired`)è§„èŒƒä½¿ç”¨

2. **å®‰å…¨ç¼–ç ä¸“å®¶çº§ç†è§£**
   - OWASP Top 10å®æˆ˜é˜²æŠ¤
   - å¯†ç å­¦åº”ç”¨(BCryptç®—æ³•)
   - ä¼šè¯å®‰å…¨ç®¡ç†

3. **å…¨é“¾è·¯å¼€å‘èƒ½åŠ›**
   - éœ€æ±‚åˆ†æ â†’ æ•°æ®åº“è®¾è®¡ â†’ åç«¯å¼€å‘ â†’ å‰ç«¯é›†æˆ â†’ å®‰å…¨æµ‹è¯• â†’ æ€§èƒ½ä¼˜åŒ–

### éš¾ç‚¹çªç ´è®°å½•

**éªŒè¯ç é›†æˆæŒ‘æˆ˜ï¼š**
- é—®é¢˜ï¼šKaptchaé…ç½®å±æ€§æ³¨å…¥å¤±è´¥
- è§£å†³ï¼šåˆ›å»ºç‹¬ç«‹çš„`KaptchaConfig`é…ç½®ç±»ï¼Œä½¿ç”¨`@Value`æ³¨è§£æ­£ç¡®æ³¨å…¥

**é˜²é‡æ”¾æ”»å‡»è®¾è®¡ï¼š**
- é—®é¢˜ï¼šéªŒè¯ç å¯é‡å¤ä½¿ç”¨
- è§£å†³ï¼šéªŒè¯åç«‹å³æ¸…é™¤Sessionä¸­çš„éªŒè¯ç 

**æ•°æ®åº“é”å®šæœºåˆ¶ï¼š**
- é—®é¢˜ï¼šé”å®šæ—¶é—´è®¡ç®—å¤æ‚
- è§£å†³ï¼šä½¿ç”¨`System.currentTimeMillis()`è¿›è¡Œç²¾ç¡®æ—¶é—´å·®è®¡ç®—

## ğŸš€ ç³»ç»Ÿæ¼”ç¤ºä¸è®¿é—®

**æœ¬åœ°è¿è¡Œï¼š**
```bash
# å¯åŠ¨åº”ç”¨
è®¿é—®ï¼šhttp://localhost:8081/login
æµ‹è¯•è´¦æˆ·ï¼šè‡ªè¡Œæ³¨å†Œ
```

**åŠŸèƒ½æ¼”ç¤ºæµç¨‹ï¼š**
1. æ­£å¸¸æ³¨å†Œç™»å½•æµç¨‹
2. SQLæ³¨å…¥æ”»å‡»å°è¯•ï¼ˆè¢«æ‹¦æˆªï¼‰
3. è¿ç»­å¤±è´¥è§¦å‘éªŒè¯ç 
4. 5æ¬¡å¤±è´¥åè´¦æˆ·é”å®š
5. éªŒè¯ç ä¸€æ¬¡æ€§ä½¿ç”¨éªŒè¯

## ğŸ“ˆ æ¶æ„æ¼”è¿›ä¸æœªæ¥è§„åˆ’

### å½“å‰æ¶æ„æ€»ç»“
```
è¡¨ç°å±‚(Thymeleaf) â†’ æ§åˆ¶å±‚(Controller) â†’ æœåŠ¡å±‚(å¯†ç åŠ å¯†) â†’ æ•°æ®å±‚(JdbcTemplate)
```

### æŠ€æœ¯å€ºåŠ¡ä¸ä¼˜åŒ–æ–¹å‘
- [ ] é›†æˆRedisç¼“å­˜éªŒè¯ç å’Œç™»å½•çŠ¶æ€
- [ ] å®ç°JWTæ— çŠ¶æ€è®¤è¯
- [ ] æ·»åŠ å®‰å…¨å®¡è®¡æ—¥å¿—
- [ ] é›†æˆSpring Securityå®Œæ•´æ¡†æ¶

### èŒä¸šå‘å±•æ˜ å°„
è¿™ä¸ªé¡¹ç›®è®©æˆ‘åœ¨ä»¥ä¸‹ä¼ä¸šçº§æŠ€èƒ½ä¸Šè·å¾—å®æˆ˜ç»éªŒï¼š
- **å®‰å…¨å¼€å‘**ï¼šOWASPæ ‡å‡†å®æ–½
- **æ•°æ®åº“è®¾è®¡**ï¼šç”¨æˆ·è¡¨ç»“æ„ä¼˜åŒ–
- **ç³»ç»Ÿæ¶æ„**ï¼šåˆ†å±‚è®¾è®¡ä¸æ¨¡å—è§£è€¦
- **é—®é¢˜æ’æŸ¥**ï¼šå®Œæ•´çš„è°ƒè¯•ä¸æµ‹è¯•æµç¨‹

## ğŸ’¡ é¡¹ç›®æ„Ÿæ‚Ÿä¸æˆé•¿

> "ä½œä¸ºæ°‘åŠæœ¬ç§‘å­¦ç”Ÿï¼Œè¿™ä¸ªé¡¹ç›®è®©æˆ‘æ·±åˆ»ä½“ä¼šåˆ°ï¼šæŠ€æœ¯èƒ½åŠ›ä¸å­¦æ ¡èƒŒæ™¯æ— å…³ï¼Œå…³é”®åœ¨äºä½ çš„å®è·µæ·±åº¦å’Œè§£å†³å¤æ‚é—®é¢˜çš„èƒ½åŠ›ã€‚ä»æœ€åˆçš„SQLæ³¨å…¥æ¼æ´ï¼Œåˆ°å¦‚ä»Šå…·å¤‡äº”å±‚é˜²æŠ¤çš„ä¼ä¸šçº§ç³»ç»Ÿï¼Œæˆ‘ä¸ä»…æŒæ¡äº†Spring Bootå…¨æ ˆå¼€å‘ï¼Œæ›´é‡è¦çš„æ˜¯å»ºç«‹äº†ç‹¬ç«‹æ¶æ„å’Œå®‰å…¨è®¾è®¡çš„ä¿¡å¿ƒã€‚"

**æŠ€æœ¯ä»·å€¼çš„ä½“ç°ï¼š**
- å•ä¸ªé¡¹ç›®è¦†ç›–**å‰ç«¯ã€åç«¯ã€æ•°æ®åº“ã€å®‰å…¨**å…¨é“¾è·¯
- ä»£ç è´¨é‡è¾¾åˆ°**ä¼ä¸šçº§å¯ç»´æŠ¤**æ ‡å‡†
- å®‰å…¨è®¾è®¡éµå¾ª**è¡Œä¸šæœ€ä½³å®è·µ**

**è½¯æŠ€èƒ½æå‡ï¼š**
- æŠ€æœ¯æ–‡æ¡£æ’°å†™èƒ½åŠ›
- ç³»ç»Ÿæ¶æ„è®¾è®¡æ€ç»´
- é—®é¢˜åˆ†è§£ä¸è§£å†³ç­–ç•¥

---

*å®Œæ•´ä»£ç å·²å¼€æºåœ¨æœ¬ä»“åº“ï¼Œè¿™ä¸ªé¡¹ç›®å·²æˆä¸ºæˆ‘æŠ€æœ¯å±¥å†ä¸­çš„äº®çœ¼æˆæœï¼Œä¸ºå³å°†åˆ°æ¥çš„å®ä¹ æ‹›è˜å­£å¥ å®šäº†åšå®åŸºç¡€ï¼*

---

**é¡¹ç›®ç»“æ„ï¼š**
```
weblogin/
â”œâ”€â”€ src/main/java/com/example/weblogin/
â”‚   â”œâ”€â”€ AuthController.java          # è®¤è¯æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ CaptchaController.java       # éªŒè¯ç æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ WebloginApplication.java     # åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ KaptchaConfig.java       # éªŒè¯ç é…ç½®
â”‚   â”‚   â””â”€â”€ SecurityConfig.java      # å®‰å…¨é…ç½®
â”œâ”€â”€ src/main/resources/
â”‚   â”œâ”€â”€ templates/
â”‚   â”‚   â”œâ”€â”€ login.html              # ç™»å½•é¡µé¢
â”‚   â”‚   â””â”€â”€ register.html           # æ³¨å†Œé¡µé¢
â”‚   â”œâ”€â”€ application.yaml            # åº”ç”¨é…ç½®
â””â”€â”€ docs/
    â”œâ”€â”€ Week1-SQL-Injection.md      # ç¬¬ä¸€ç¯‡åšå®¢
    â””â”€â”€ Week2-Security-System.md    # æœ¬ç¯‡åšå®¢
```

**å¿«é€Ÿå¼€å§‹ï¼š**
1. å…‹éš†æœ¬ä»“åº“
2. é…ç½®MySQLæ•°æ®åº“
3. è¿è¡Œ`WebloginApplication`
4. è®¿é—® http://localhost:8081/login

---
*ä¸‹ä¸€ç¯‡ï¼šæˆ‘å°†åˆ†äº«å¦‚ä½•å°†è¿™ä¸ªç³»ç»Ÿéƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨ï¼Œå¹¶å®ç°HTTPSåŠ å¯†ä¼ è¾“*
